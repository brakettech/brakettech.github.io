<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Bodhi Solar Defender</title>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
  width: 100%; height: 100%;
  background: #000;
  overflow: hidden;
  font-family: monospace;
  touch-action: none;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
}
#gameContainer {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}
canvas {
  display: block;
  image-rendering: pixelated;
  image-rendering: crisp-edges;
}
#scanlines {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none;
  background: repeating-linear-gradient(0deg, rgba(0,0,0,0.12) 0px, rgba(0,0,0,0.12) 1px, transparent 1px, transparent 3px);
  z-index: 10;
}
#crtOverlay {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none;
  box-shadow: inset 0 0 80px rgba(0,0,0,0.5);
  border-radius: 6px;
  z-index: 11;
}
/* Portrait rotation message ‚Äî mobile only */
#rotateMsg {
  display: none;
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: #000;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  z-index: 200;
  color: #FFD110;
  text-align: center;
  padding: 20px;
  font-family: monospace;
}
#rotateMsg span { font-size: 52px; display: block; margin-bottom: 16px; }
#rotateMsg p { font-size: 16px; color: #FF6F47; }
/* Only show rotate message on narrow portrait screens (phones) */
@media (orientation: portrait) and (max-width: 600px) {
  #rotateMsg { display: flex !important; }
  #gameContainer { display: none !important; }
}
#nameInput {
  position: absolute; top: 0; left: 0;
  width: 1px; height: 1px;
  opacity: 0; pointer-events: none;
}
/* Mobile touch zone hints ‚Äî only shown briefly at start */
#touchHints {
  display: none;
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none;
  z-index: 5;
}
</style>

<script>
(function() {
  var img = new Image();
  img.onload = function() {
    var c = document.createElement('canvas');
    c.width = 64; c.height = 64;
    c.getContext('2d').drawImage(img, 0, 0, 64, 64);
    var link = document.createElement('link');
    link.rel = 'icon';
    link.type = 'image/png';
    link.href = c.toDataURL('image/png');
    document.head.appendChild(link);
  };
  img.src = 'data:image/jpeg;base64,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';
})();
</script>
</head>
<body>
<div id="rotateMsg">
  <span>üì±‚ÜîÔ∏è</span>
  <p>Please rotate your phone<br>to landscape mode to play</p>
</div>
<div id="gameContainer">
  <canvas id="game"></canvas>
  <div id="scanlines"></div>
  <div id="crtOverlay"></div>
  <input id="nameInput" type="text" maxlength="10" autocomplete="off" />
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const nameInput = document.getElementById('nameInput');

// ‚îÄ‚îÄ Internal game resolution (fixed) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const GW = 1024, GH = 640;
canvas.width = GW; canvas.height = GH;

// ‚îÄ‚îÄ Detect touch device ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

// ‚îÄ‚îÄ Responsive scaling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function resize() {
  const sw = window.innerWidth, sh = window.innerHeight;
  const scale = Math.min(sw / GW, sh / GH);
  canvas.style.width  = Math.floor(GW * scale) + 'px';
  canvas.style.height = Math.floor(GH * scale) + 'px';
}
resize();
window.addEventListener('resize', resize);
window.addEventListener('orientationchange', () => { setTimeout(resize, 120); });

// Helper: convert a client touch position into canvas (game) coordinates
function clientToGame(clientX, clientY) {
  const rect = canvas.getBoundingClientRect();
  return {
    x: (clientX - rect.left) * (GW / rect.width),
    y: (clientY - rect.top)  * (GH / rect.height)
  };
}

const W = GW, H = GH;
const GOLD = '#FFD110', NAVY = '#00142D', ORANGE = '#FF6F47';
const GOLD_DIM = '#B8960B', NAVY_LIGHT = '#0A2E5C', ORANGE_LIGHT = '#FF9A7A';

// ‚îÄ‚îÄ Game state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let state = 'title';
let level = 1, lives = 3, score = 0, powerMeter = 0;
let scrollX = 0, scrollSpeed = 1;
let sunBrightness = 1, sunDimTimer = 0, screenDim = 0;
let invincibleTimer = 0, levelTransitionTimer = 0, flashTimer = 0;
let keys = {};
let enemies = [], lasers = [], bolts = [], particles = [], solarPanels = [];
let enemyTimer = 0, boltTimer = 0, shootCooldown = 0, gameTime = 0;
let nextPanelX = 60;
// Solar orb power-up
let solarOrbs = [], solarOrbTimer = 0, tripleShot = false, tripleShotTimer = 0;
// Bird easter egg (level 2)
let bird = null, birdTimer = 0, birdUsed = false, flowersActive = false, flowerTimer = 0, panelFlowers = [];
let celebrationParticles = [], victoryFireworks = [], victoryTimer = 0;
let leaderboard = [], playerName = '', nameEntered = false, cursorBlink = 0;

const GROUND_Y = 520;
const levelNames = ['the Grasslands', 'the Mountains', 'the City'];
const levels = [
  { name: 'GRASSLAND', enemyInterval: 68, enemySpeed: 1.5, bg: 'grassland' },
  { name: 'MOUNTAINS', enemyInterval: 45, enemySpeed: 5.5, bg: 'mountains' },
  { name: 'CITY',      enemyInterval: 40, enemySpeed: 6.0, bg: 'city'      }
];
const hero = { x: 100, y: 250, w: 96, h: 48, speed: 4 };

// ‚îÄ‚îÄ Touch control state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Left zone (x < W*0.6) = drag-to-move joystick
// Right zone (x >= W*0.6) = hold-to-shoot button
let touchMove = null;   // { id, startX, startY, heroStartX, heroStartY }
let touchShoot = null;  // { id }
let touchHintTimer = 0; // counts up; we show hints for first ~300 frames

// ‚îÄ‚îÄ Keyboard input ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e => {
  keys[e.code] = true;
  if (['Space','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.code)) e.preventDefault();
  if (e.code === 'Escape') {
    if (state === 'playing' || state === 'levelComplete') { stopMusic(); state = 'title'; }
    if (state === 'leaderboard') state = 'title';
  }
});
document.addEventListener('keyup', e => { keys[e.code] = false; });
nameInput.addEventListener('input', () => {
  playerName = nameInput.value.toUpperCase().replace(/[^A-Z0-9 ]/g, '').substring(0, 10);
  nameInput.value = playerName;
});

// ‚îÄ‚îÄ Touch event handlers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
canvas.addEventListener('touchstart', e => {
  e.preventDefault();
  for (const t of e.changedTouches) {
    const pos = clientToGame(t.clientX, t.clientY);

    // ---- Title ----
    if (state === 'title') {
      state = 'playing'; level = 1; lives = 3; score = 0;
      resetLevel(); startMusic(1);
      return;
    }
    // ---- Game Over ----
    if (state === 'gameOver') {
      state = 'leaderboard'; nameEntered = false; playerName = '';
      nameInput.value = ''; victoryFireworks = [];
      nameInput.style.pointerEvents = 'auto'; nameInput.focus();
      return;
    }
    // ---- Leaderboard ----
    if (state === 'leaderboard') {
      if (!nameEntered) {
        if (pos.x >= confirmBtn.x && pos.x <= confirmBtn.x + confirmBtn.w &&
            pos.y >= confirmBtn.y && pos.y <= confirmBtn.y + confirmBtn.h) {
          nameEntered = true;
          leaderboard.forEach(e2 => { e2.isNew = false; });
          addToLeaderboard(playerName || 'ANON', score);
          nameInput.style.pointerEvents = 'none';
        } else {
          nameInput.style.pointerEvents = 'auto';
          nameInput.focus();
        }
      } else {
        state = 'title';
      }
      return;
    }
    // ---- Playing ----
    if (state === 'playing') {
      if (pos.x >= W * 0.6) {
        touchShoot = { id: t.identifier };
      } else {
        touchMove = {
          id: t.identifier,
          startX: pos.x, startY: pos.y,
          heroStartX: hero.x, heroStartY: hero.y
        };
      }
    }
  }
}, { passive: false });

canvas.addEventListener('touchmove', e => {
  e.preventDefault();
  if (state !== 'playing') return;
  for (const t of e.changedTouches) {
    if (touchMove && t.identifier === touchMove.id) {
      const pos = clientToGame(t.clientX, t.clientY);
      hero.x = Math.max(5, Math.min(W - hero.w - 5,  touchMove.heroStartX + (pos.x - touchMove.startX)));
      hero.y = Math.max(5, Math.min(GROUND_Y - hero.h - 20, touchMove.heroStartY + (pos.y - touchMove.startY)));
    }
  }
}, { passive: false });

canvas.addEventListener('touchend', e => {
  e.preventDefault();
  for (const t of e.changedTouches) {
    if (touchMove  && t.identifier === touchMove.id)  touchMove  = null;
    if (touchShoot && t.identifier === touchShoot.id) touchShoot = null;
  }
}, { passive: false });

canvas.addEventListener('touchcancel', e => {
  e.preventDefault();
  touchMove = null; touchShoot = null;
}, { passive: false });

// ‚îÄ‚îÄ Utility ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function px(x, y, w, h, c) { ctx.fillStyle = c; ctx.fillRect(Math.floor(x), Math.floor(y), w, h); }

// ‚îÄ‚îÄ AUDIO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let audioCtx = null, musicInterval = null, musicPlaying = false;
function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}
function playTone(f, d, tp, v, t) {
  try {
    let ac = getAudioCtx(), o = ac.createOscillator(), g = ac.createGain();
    o.type = tp || 'square';
    o.frequency.setValueAtTime(f, t || ac.currentTime);
    g.gain.setValueAtTime(v || 0.08, t || ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, (t || ac.currentTime) + d);
    o.connect(g); g.connect(ac.destination);
    o.start(t || ac.currentTime); o.stop((t || ac.currentTime) + d);
  } catch(e) {}
}
function playSfx(type) {
  let ac = getAudioCtx(), t = ac.currentTime;
  if (type === 'shoot')   { playTone(880,0.08,'square',0.06,t); playTone(660,0.06,'square',0.04,t+0.03); }
  else if (type === 'explode') { playTone(120,0.2,'sawtooth',0.1,t); playTone(80,0.3,'sawtooth',0.08,t+0.05); playTone(50,0.2,'square',0.06,t+0.1); }
  else if (type === 'collect') { [523,659,784,1047].forEach((n,i) => playTone(n,0.1,'square',0.08,t+i*0.08)); }
  else if (type === 'hit')    { playTone(200,0.15,'sawtooth',0.12,t); playTone(100,0.2,'sawtooth',0.1,t+0.08); }
  else if (type === 'levelup'){ [523,659,784,1047,784,1047,1319].forEach((n,i) => playTone(n,0.18,'square',0.1,t+i*0.12)); }
  else if (type === 'victory') { [523,659,784,1047,784,1047,1319,1047,1319,1568].forEach((n,i) => { playTone(n,0.25,'square',0.1,t+i*0.15); if(i%2===0) playTone(n/2,0.3,'triangle',0.06,t+i*0.15); }); }
}
let musicStep = 0;
const melodyA = [196,220,262,294,330,294,262,220,196,247,294,330,392,330,294,247,262,294,330,392,440,392,330,294,349,330,294,262,247,220,196,0,392,440,494,523,494,440,392,0,330,349,392,440,392,349,330,0,294,330,349,392,440,494,523,494,440,392,349,330,294,262,220,0];
const bassA   = [98,0,131,0,98,0,131,0,110,0,147,0,110,0,147,0,131,0,165,0,131,0,165,0,117,0,147,0,117,0,98,0,165,0,196,0,165,0,196,0,131,0,165,0,131,0,165,0,147,0,175,0,147,0,196,0,131,0,165,0,110,0,98,0];
const arpA    = [0,262,0,330,0,262,0,330,0,294,0,349,0,294,0,349,0,330,0,392,0,330,0,392,0,294,0,349,0,262,0,0,0,392,0,494,0,392,0,0,0,330,0,392,0,330,0,0,0,349,0,440,0,349,0,494,0,330,0,392,0,294,0,0];
function startMusic(lvl) {
  stopMusic(); musicPlaying = true; musicStep = 0;
  let tempo = 120 / Math.pow(1.25, lvl - 1);
  musicInterval = setInterval(() => {
    if (!musicPlaying) return;
    let ac = getAudioCtx(), t = ac.currentTime;
    let mel = melodyA[musicStep % melodyA.length], bas = bassA[musicStep % bassA.length], arp = arpA[musicStep % arpA.length];
    if (mel > 0) playTone(mel, tempo/1000*0.7, 'square', 0.04, t);
    if (bas > 0) playTone(bas, tempo/1000*0.9, 'triangle', 0.05, t);
    if (arp > 0) playTone(arp, tempo/1000*0.4, 'sawtooth', 0.02, t);
    if (musicStep%4===0) { try { let o=ac.createOscillator(),g=ac.createGain();o.type='sine';o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(30,t+0.08);g.gain.setValueAtTime(0.06,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.1);o.connect(g);g.connect(ac.destination);o.start(t);o.stop(t+0.1); } catch(e){} }
    if (musicStep%2===1) { try { let o=ac.createOscillator(),g=ac.createGain();o.type='square';o.frequency.setValueAtTime(800+Math.random()*400,t);g.gain.setValueAtTime(0.015,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.03);o.connect(g);g.connect(ac.destination);o.start(t);o.stop(t+0.04); } catch(e){} }
    musicStep++;
  }, tempo);
}
function stopMusic() { musicPlaying = false; if (musicInterval) { clearInterval(musicInterval); musicInterval = null; } }

// ‚îÄ‚îÄ HERO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawHero(x, y) {
  let X = Math.floor(x), Y = Math.floor(y);
  let cw1 = Math.sin(Date.now()/140)*3, cw2 = Math.sin(Date.now()/110+1)*2.5, cw3 = Math.sin(Date.now()/90+2)*2;
  // Cape
  px(X+22, Y+8,  24, 5, ORANGE);
  px(X+14, Y+4+cw1, 20, 6, ORANGE);
  px(X+4,  Y+1+cw2, 18, 6, ORANGE);
  px(X-8+cw1,  Y-2+cw3,  16, 5, ORANGE_LIGHT);
  px(X-20+cw2, Y-4+cw1,  14, 5, ORANGE_LIGHT);
  px(X-30+cw1, Y-3+cw2,  10, 4, ORANGE_LIGHT);
  px(X+10, Y+6+cw2, 8, 3, ORANGE_LIGHT);
  px(X-4+cw1, Y+0+cw3, 8, 3, ORANGE);
  // Torso
  px(X+18, Y+14, 36, 16, NAVY);
  px(X+16, Y+16, 40, 12, NAVY);
  // Head
  px(X+54, Y+10, 22, 22, GOLD);
  px(X+56, Y+12, 18, 18, GOLD);
  px(X+70, Y+16,  4,  5, '#FFF');
  px(X+72, Y+17,  2,  3, NAVY);
  px(X+68, Y+14,  6,  2, NAVY);
  px(X+54, Y+8,  22,  6, NAVY);
  px(X+56, Y+6,  16,  4, NAVY);
  // Arms
  px(X+56, Y+18, 28, 5, GOLD);
  px(X+80, Y+16, 10, 7, GOLD);
  px(X+86, Y+16,  6, 7, ORANGE);
  // Legs
  px(X+8,  Y+18, 12, 6, NAVY);
  px(X+4,  Y+20, 10, 6, NAVY);
  px(X-2,  Y+22, 10, 5, NAVY);
  px(X+12, Y+20,  8, 5, NAVY);
  px(X-6,  Y+24,  8, 4, ORANGE);
  px(X+2,  Y+25,  8, 4, ORANGE);
  // Belt & emblem
  px(X+20, Y+14, 34, 3, GOLD);
  px(X+34, Y+18,  8, 7, GOLD);
  px(X+36, Y+20,  4, 3, '#FFF');
  if (invincibleTimer > 0 && Math.floor(invincibleTimer/5)%2===0) {
    ctx.globalAlpha = 0.35; ctx.fillStyle = GOLD;
    ctx.fillRect(X-34, Y-8, 132, 42); ctx.globalAlpha = 1;
  }
}

// ‚îÄ‚îÄ ENEMIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawCoal(x,y){px(x+8,y+4,40,40,'#222');px(x+4,y+10,48,28,'#1a1a1a');px(x+12,y+6,32,36,'#333');px(x+16,y+10,10,6,'#555');px(x+32,y+20,12,6,'#444');px(x+20,y+30,8,6,'#4a4a4a');px(x+22,y+44,16,6,'#888');px(x+28,y+14,6,4,ORANGE);px(x+14,y+24,4,4,'#CC3300');}
function drawOilDrop(x,y){let cx=x+28;px(cx-2,y+2,4,4,'#111');px(cx-4,y+6,8,4,'#1a1a1a');px(cx-6,y+10,12,4,'#222');px(cx-8,y+14,16,4,'#222');px(cx-10,y+18,20,4,'#1a1a1a');px(cx-12,y+22,24,6,'#111');px(cx-14,y+26,28,6,'#0a0a0a');px(cx-14,y+32,28,6,'#111');px(cx-12,y+38,24,4,'#1a1a1a');px(cx-10,y+42,20,4,'#222');px(cx-6,y+46,12,4,'#222');px(cx-3,y+50,6,3,'#333');px(cx-6,y+14,4,10,'#333');px(cx-4,y+12,3,6,'#444');px(cx+8,y+44,4,6,'#333');px(cx+10,y+48,3,4,'#444');}
function drawSmoke(x,y,t){let o1=Math.sin(t/20)*4,o2=Math.cos(t/16)*5;ctx.globalAlpha=0.6;px(x+6+o1,y+10,24,24,'#777');px(x+18+o2,y+4,24,24,'#999');px(x+10,y+16,32,20,'#888');px(x+24-o1,y+22,20,20,'#aaa');px(x+14+o2,y+8,18,16,'#bbb');px(x+30,y+14+o1,12,16,'#999');ctx.globalAlpha=1;}
function drawEnemy(e){if(e.type==='coal')drawCoal(e.x,e.y);else if(e.type==='oil')drawOilDrop(e.x,e.y);else drawSmoke(e.x,e.y,e.t);}

// ‚îÄ‚îÄ PROJECTILES & PICKUPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawBolt(b){
  let X=Math.floor(b.x),Y=Math.floor(b.y),t=b.t,fl=Math.sin(t*0.8)*0.15+Math.sin(t*1.7)*0.1;
  ctx.globalAlpha=0.2+fl;ctx.fillStyle=GOLD;ctx.fillRect(X-8,Y-8,58,68);ctx.globalAlpha=1;
  let sg=[{x:18,y:0,w:10,h:6},{x:22,y:4,w:8,h:5},{x:14,y:8,w:12,h:5},{x:8,y:12,w:14,h:4},{x:2,y:15,w:38,h:6},{x:20,y:20,w:10,h:5},{x:26,y:24,w:8,h:5},{x:16,y:28,w:14,h:5},{x:10,y:32,w:12,h:5},{x:18,y:36,w:8,h:5},{x:22,y:40,w:6,h:5},{x:20,y:44,w:4,h:5}];
  sg.forEach(s=>{px(X+s.x-1,Y+s.y-1,s.w+2,s.h+2,'rgba(100,180,255,0.4)');});
  sg.forEach(s=>{px(X+s.x,Y+s.y,s.w,s.h,GOLD);});
  sg.forEach(s=>{px(X+s.x+2,Y+s.y+1,Math.max(2,s.w-4),Math.max(2,s.h-2),'#FFF');});
  let sp=Math.floor(t/3)%4;
  if(sp===0){px(X+2,Y+14,6,3,'#AAD4FF');px(X+36,Y+16,6,3,'#AAD4FF');}
  if(sp===1){px(X+6,Y+10,4,3,'#88BBFF');px(X+32,Y+20,5,3,'#88BBFF');}
  if(sp===2){px(X+28,Y+12,6,2,GOLD);px(X+8,Y+30,5,3,GOLD);}
  if(sp===3){px(X+4,Y+18,5,2,'#FFF');px(X+34,Y+26,4,3,'#FFF');}
  for(let i=0;i<3;i++){let sx=X+10+Math.sin(t*0.5+i*2.1)*16,sy=Y+10+Math.cos(t*0.7+i*1.8)*18,sz=2+(Math.floor(t+i)%2);ctx.fillStyle=i%2===0?'#FFF':'#AAD4FF';ctx.fillRect(Math.floor(sx),Math.floor(sy),sz,sz);}
}
function drawLaser(l){px(l.x,l.y,20,5,ORANGE);px(l.x+3,l.y+1,14,3,GOLD);px(l.x+16,l.y+1,6,3,'#FFF');}

function drawSolarOrb(o){
  let t=o.t,pulse=Math.sin(t*0.15)*4;
  ctx.globalAlpha=0.2+Math.sin(t*0.1)*0.1;ctx.fillStyle='#FFE866';
  ctx.beginPath();ctx.arc(o.x+12,o.y+12,16+pulse,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;
  ctx.beginPath();ctx.arc(o.x+12,o.y+12,12,0,Math.PI*2);ctx.fillStyle='#FF8C00';ctx.fill();
  ctx.beginPath();ctx.arc(o.x+12,o.y+12, 9,0,Math.PI*2);ctx.fillStyle='#FFC200';ctx.fill();
  ctx.beginPath();ctx.arc(o.x+12,o.y+12, 6,0,Math.PI*2);ctx.fillStyle='#FFE866';ctx.fill();
  ctx.beginPath();ctx.arc(o.x+12,o.y+12, 3,0,Math.PI*2);ctx.fillStyle='#FFF';ctx.fill();
  ctx.save();ctx.translate(o.x+12,o.y+12);ctx.rotate(t*0.08);
  ctx.globalAlpha=0.7;ctx.fillStyle='#FFD110';
  for(let i=0;i<6;i++){ctx.save();ctx.rotate(i*Math.PI/3);ctx.fillRect(-1.5,-15,3,5);ctx.restore();}
  ctx.globalAlpha=1;ctx.restore();
}

function drawBird(b){
  let X=Math.floor(b.x),Y=Math.floor(b.y),flap=Math.sin(b.t*0.3)*3;
  px(X+4,Y+4,10,6,'#FFDD55');px(X+2,Y+5,4,4,'#FFEE88');
  if(flap>0){px(X,Y+2,5,3,'#FFDD55');px(X+12,Y+2,5,3,'#FFDD55');}
  else{px(X+1,Y+6,4,2,'#FFDD55');px(X+13,Y+6,4,2,'#FFDD55');}
  px(X+12,Y+2,6,6,'#FFDD55');px(X+17,Y+4,4,2,'#FF9900');
  px(X+14,Y+3,2,2,'#222');px(X,Y+5,3,3,'#FFCC00');
}

function drawFlowers(){
  if(!flowersActive||panelFlowers.length===0)return;
  let alpha=Math.min(1,flowerTimer/60)*Math.min(1,(flowerTimer>500?(700-flowerTimer)/200:1));
  ctx.globalAlpha=alpha;
  for(let f of panelFlowers){
    let sx=((f.worldX - scrollX*0.5)%(W+600)+W+600)%(W+600)-300;
    if(sx<-60||sx>W+60)continue;
    let sc=f.scale*(0.5+Math.min(1,flowerTimer/80)*0.5);
    let X=Math.floor(sx), Y=GROUND_Y;
    let stemH=Math.floor(f.stemH*sc);
    let ps=Math.floor(f.petalSize*sc);
    ctx.fillStyle='#3d8830';ctx.fillRect(X,Y-stemH,3,stemH);
    let cx=X+1,cy=Y-stemH-ps;
    ctx.fillStyle=f.color;
    ctx.fillRect(cx-ps*2,cy-ps,ps,ps);ctx.fillRect(cx+ps,cy-ps,ps,ps);
    ctx.fillRect(cx-ps,cy-ps*3,ps,ps);ctx.fillRect(cx,cy-ps*3,ps,ps);
    ctx.fillRect(cx-ps,cy+ps,ps,ps);ctx.fillRect(cx,cy+ps,ps,ps);
    ctx.fillStyle='#FFD110';ctx.fillRect(cx-ps/2|0,cy-ps,ps+1,ps+1);
    ctx.fillStyle='rgba(255,255,255,0.6)';ctx.fillRect((cx-ps/2|0)+1,cy-ps+1,Math.max(2,ps-2),Math.max(2,ps-2));
  }
  ctx.globalAlpha=1;
}

// ‚îÄ‚îÄ SUN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawSun(){
  let sx=900,sy=80,r=90,b=sunBrightness;
  ctx.globalAlpha=0.2*b;ctx.fillStyle=GOLD;
  for(let i=0;i<12;i++){let a=(Date.now()/2000)+i*Math.PI/6;ctx.save();ctx.translate(sx,sy);ctx.rotate(a);ctx.fillRect(-5,-r-45,10,45);ctx.restore();}
  ctx.globalAlpha=0.1*b;
  for(let i=0;i<12;i++){let a=(Date.now()/3000)+i*Math.PI/6+0.26;ctx.save();ctx.translate(sx,sy);ctx.rotate(a);ctx.fillRect(-3,-r-60,6,35);ctx.restore();}
  ctx.globalAlpha=1;
  ctx.beginPath();ctx.arc(sx,sy,r,0,Math.PI*2);ctx.fillStyle=`rgba(255,209,16,${b})`;ctx.fill();
  ctx.beginPath();ctx.arc(sx,sy,r-22,0,Math.PI*2);ctx.fillStyle=`rgba(255,240,100,${b})`;ctx.fill();
  ctx.beginPath();ctx.arc(sx,sy,r-44,0,Math.PI*2);ctx.fillStyle=`rgba(255,250,200,${b*0.7})`;ctx.fill();
  if(b<1){ctx.beginPath();ctx.arc(sx,sy,r+12,0,Math.PI*2);ctx.fillStyle=`rgba(30,30,50,${(1-b)*0.6})`;ctx.fill();}
}

// ‚îÄ‚îÄ BACKGROUNDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawSky(){
  let grad=ctx.createLinearGradient(0,0,0,H);
  if(level===1){grad.addColorStop(0,'#1E88CC');grad.addColorStop(0.3,'#3399DD');grad.addColorStop(0.6,'#55BBEE');grad.addColorStop(1,'#77DDFF');}
  else if(level===2){grad.addColorStop(0,'#2080CC');grad.addColorStop(0.3,'#3898DD');grad.addColorStop(0.6,'#50B0EE');grad.addColorStop(1,'#70CCFF');}
  else{grad.addColorStop(0,'#2288DD');grad.addColorStop(0.3,'#44AAEE');grad.addColorStop(0.6,'#66CCFF');grad.addColorStop(1,'#88DDFF');}
  ctx.fillStyle=grad;ctx.fillRect(0,0,W,H);
  ctx.fillStyle='rgba(255,255,255,0.55)';
  let cc=level===3?7:5;
  for(let i=0;i<cc;i++){
    let cx=((i*195+40)-scrollX*0.08)%(W+250)-125,cy=30+(i%3)*35;
    ctx.beginPath();ctx.arc(cx,cy,20,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(cx+24,cy-6,25,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(cx+50,cy,18,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(cx+22,cy+10,16,0,Math.PI*2);ctx.fill();
  }
}
function drawGrassland(sx){
  ctx.fillStyle='#4aA040';ctx.beginPath();ctx.moveTo(0,GROUND_Y+10);
  for(let i=0;i<=W;i+=5){let h=Math.sin((i+sx*0.3)/120)*15+Math.sin((i+sx*0.2)/60)*8;ctx.lineTo(i,GROUND_Y-5+h);}
  ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.fill();
  ctx.fillStyle='#3d8830';ctx.fillRect(0,GROUND_Y+20,W,H-GROUND_Y-20);
  for(let i=0;i<30;i++){let gx=((i*45+10)-sx*0.5)%(W+100)-50,gy=GROUND_Y-8+(i%3)*6;px(gx,gy,3,10,'#5ab84a');px(gx+5,gy+2,3,8,'#4a9d3a');px(gx-4,gy+1,3,9,'#6ac85a');}
  for(let i=0;i<12;i++){let fx=((i*95+30)-sx*0.3)%(W+80)-40;ctx.fillStyle=[GOLD,ORANGE,'#FF88AA','#88DDFF'][i%4];ctx.fillRect(fx,GROUND_Y-10,6,6);ctx.fillStyle='#4aA040';ctx.fillRect(fx+2,GROUND_Y-4,2,8);}
}
function drawMountains(sx){
  ctx.fillStyle='#3A6A8C';for(let i=0;i<8;i++){let mx=((i*180)-sx*0.12)%(W+500)-250;ctx.beginPath();ctx.moveTo(mx,GROUND_Y);ctx.lineTo(mx+120,200+(i%3)*60);ctx.lineTo(mx+240,GROUND_Y);ctx.fill();}
  ctx.fillStyle='#2A5A7A';for(let i=0;i<7;i++){let mx=((i*200+80)-sx*0.25)%(W+500)-250;ctx.beginPath();ctx.moveTo(mx,GROUND_Y);ctx.lineTo(mx+90,280+(i%2)*50);ctx.lineTo(mx+180,GROUND_Y);ctx.fill();}
  for(let i=0;i<7;i++){let mx=((i*200+80)-sx*0.25)%(W+500)-250;let pk=280+(i%2)*50;ctx.fillStyle='#FFFAF0';ctx.beginPath();ctx.moveTo(mx+60,pk+18);ctx.lineTo(mx+90,pk);ctx.lineTo(mx+120,pk+18);ctx.fill();}
  ctx.fillStyle='#3A7A4A';ctx.fillRect(0,GROUND_Y,W,H-GROUND_Y);ctx.fillStyle='#2E6A3E';ctx.fillRect(0,GROUND_Y+30,W,H-GROUND_Y-30);
  for(let i=0;i<16;i++){let tx=((i*75+20)-sx*0.4)%(W+200)-100;ctx.fillStyle='#2A5A30';ctx.fillRect(tx+8,GROUND_Y-18,4,18);ctx.fillStyle='#3D7A3A';ctx.beginPath();ctx.moveTo(tx,GROUND_Y-10);ctx.lineTo(tx+10,GROUND_Y-35);ctx.lineTo(tx+20,GROUND_Y-10);ctx.fill();ctx.beginPath();ctx.moveTo(tx+2,GROUND_Y-20);ctx.lineTo(tx+10,GROUND_Y-42);ctx.lineTo(tx+18,GROUND_Y-20);ctx.fill();}
}
function drawCity(sx){
  let bC=['#556677','#667788','#5A6A7A','#6B7B8B','#4A5A6A','#7A8A9A','#506070'];
  for(let i=0;i<14;i++){let bx=((i*100+15)-sx*0.1)%(W+400)-200;let bh=130+(i*47%120);ctx.fillStyle=bC[(i+2)%bC.length];ctx.fillRect(bx,GROUND_Y-bh,45,bh);
    for(let wy=GROUND_Y-bh+10;wy<GROUND_Y-5;wy+=12){for(let wx=bx+5;wx<bx+40;wx+=10){if(Math.random()>0.3){ctx.fillStyle=Math.random()>0.5?'#AAE0FF':'#CCF0FF';ctx.globalAlpha=0.5+Math.random()*0.4;ctx.fillRect(wx,wy,4,5);ctx.globalAlpha=1;}}}}
  for(let i=0;i<16;i++){let bx=((i*70+40)-sx*0.25)%(W+350)-175;let bh=80+(i*37%140);ctx.fillStyle=bC[i%bC.length];ctx.fillRect(bx,GROUND_Y-bh,60,bh);ctx.fillStyle='#8899AA';ctx.fillRect(bx+2,GROUND_Y-bh,56,3);
    for(let wy=GROUND_Y-bh+10;wy<GROUND_Y-5;wy+=14){for(let wx=bx+6;wx<bx+54;wx+=12){if(Math.random()>0.3){ctx.fillStyle=Math.random()>0.6?'#AAE0FF':'#CCF0FF';ctx.globalAlpha=0.5+Math.random()*0.4;ctx.fillRect(wx,wy,5,6);ctx.globalAlpha=1;}}}}
  ctx.fillStyle='#777';ctx.fillRect(0,GROUND_Y,W,H-GROUND_Y);ctx.fillStyle='#666';ctx.fillRect(0,GROUND_Y+30,W,H-GROUND_Y-30);
  ctx.fillStyle=GOLD;for(let i=0;i<25;i++){let lx=((i*55)-sx*0.5)%(W+120)-60;ctx.fillRect(lx,GROUND_Y+50,28,3);}
  ctx.fillStyle='#999';ctx.fillRect(0,GROUND_Y,W,6);
}
function drawBackground(sx){drawSky();drawSun();let bg=levels[level-1].bg;if(bg==='grassland')drawGrassland(sx);else if(bg==='mountains')drawMountains(sx);else drawCity(sx);}

// ‚îÄ‚îÄ SOLAR PANELS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawSolarPanel(spx,spy){
  px(spx+40,spy+36,6,24,'#888');px(spx+34,spy+56,18,6,'#777');
  px(spx,spy,86,38,'#1A3A6A');px(spx+2,spy+2,82,34,NAVY_LIGHT);
  for(let r=0;r<2;r++){for(let c=0;c<4;c++){let cx=spx+4+c*20,cy=spy+4+r*17;px(cx,cy,18,14,'#2255BB');px(cx+1,cy+1,16,12,'#3366CC');px(cx+8,cy,1,14,'#2255BB');px(cx,cy+6,18,1,'#2255BB');}}
  px(spx+4,spy+4,6,4,'rgba(255,255,255,0.3)');
  px(spx,spy,86,2,GOLD_DIM);px(spx,spy+36,86,2,GOLD_DIM);
}
function drawSolarPanels(){
  for(let i=0;i<solarPanels.length;i++){
    let sp=solarPanels[i],sx=sp.worldX-scrollX*0.5,ww=W+500;
    sx=((sx%ww)+ww)%ww-250;
    if(sx<-100||sx>W+100)continue;
    drawSolarPanel(sx,sp.y);
  }
}

// ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spawnExplosion(x,y){for(let i=0;i<18;i++){let a=Math.random()*Math.PI*2,s=1.5+Math.random()*4;particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:20+Math.random()*18,maxLife:38,color:[ORANGE,GOLD,'#FF4444','#FFF',ORANGE_LIGHT][Math.floor(Math.random()*5)],size:3+Math.random()*6});}}
function spawnCelebration(){celebrationParticles=[];for(let i=0;i<100;i++){celebrationParticles.push({x:W/2+(Math.random()-0.5)*400,y:H+10,vx:(Math.random()-0.5)*5,vy:-3-Math.random()*6,life:60+Math.random()*60,maxLife:120,color:[GOLD,ORANGE,'#FFF',ORANGE_LIGHT,'#88DDFF','#FF88AA'][Math.floor(Math.random()*6)],size:3+Math.random()*6,gravity:0.03});}}
function spawnFirework(x,y){let cs=[GOLD,ORANGE,'#FF88AA','#88DDFF','#FFF',ORANGE_LIGHT,'#88FF88'],c=cs[Math.floor(Math.random()*cs.length)];for(let i=0;i<30;i++){let a=Math.random()*Math.PI*2,s=1+Math.random()*4;victoryFireworks.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:30+Math.random()*30,maxLife:60,color:c,size:2+Math.random()*4,gravity:0.04});}}
function updateCelebrationParticles(){for(let i=celebrationParticles.length-1;i>=0;i--){let p=celebrationParticles[i];p.x+=p.vx;p.y+=p.vy;p.vy+=p.gravity;p.life--;if(p.life<=0)celebrationParticles.splice(i,1);}}
function drawCelebrationParticles(){celebrationParticles.forEach(p=>{ctx.globalAlpha=Math.min(1,p.life/p.maxLife*2);ctx.fillStyle=p.color;ctx.fillRect(Math.floor(p.x),Math.floor(p.y),p.size,p.size);});ctx.globalAlpha=1;}
function updateFireworks(){for(let i=victoryFireworks.length-1;i>=0;i--){let p=victoryFireworks[i];p.x+=p.vx;p.y+=p.vy;p.vy+=p.gravity;p.vx*=0.98;p.life--;if(p.life<=0)victoryFireworks.splice(i,1);}}
function drawFireworks(){victoryFireworks.forEach(p=>{ctx.globalAlpha=Math.min(1,p.life/p.maxLife*2);ctx.fillStyle=p.color;ctx.fillRect(Math.floor(p.x),Math.floor(p.y),p.size,p.size);});ctx.globalAlpha=1;}

// ‚îÄ‚îÄ HUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawHUD(){
  // Power meter (vertical bar, left side)
  ctx.fillStyle='rgba(0,20,45,0.85)';ctx.fillRect(10,60,40,280);
  ctx.strokeStyle=GOLD;ctx.lineWidth=2;ctx.strokeRect(10,60,40,280);
  let mH=(powerMeter/10)*274,gr=ctx.createLinearGradient(0,338-mH,0,338);
  gr.addColorStop(0,GOLD);gr.addColorStop(1,ORANGE);
  ctx.fillStyle=gr;ctx.fillRect(12,338-mH,36,mH);
  for(let i=1;i<10;i++){ctx.fillStyle='rgba(255,255,255,0.25)';ctx.fillRect(12,338-(i/10)*274,36,1);}
  ctx.fillStyle=GOLD;ctx.font='bold 11px monospace';ctx.textAlign='center';
  ctx.fillText('POWER',30,55);ctx.fillText(powerMeter+'/10',30,355);
  // Lives
  ctx.fillStyle='#FFF';ctx.font='bold 13px monospace';ctx.textAlign='left';ctx.fillText('LIVES',10,380);
  for(let i=0;i<lives;i++){px(10+i*18,388,14,14,ORANGE);px(12+i*18,390,10,10,GOLD);}
  // Score & level
  ctx.fillStyle=GOLD;ctx.font='bold 16px monospace';ctx.textAlign='right';ctx.fillText('SCORE: '+score,W-20,30);
  ctx.textAlign='center';ctx.fillStyle=ORANGE;ctx.font='bold 16px monospace';ctx.fillText('LEVEL '+level+': '+levels[level-1].name,W/2,30);
  // Controls hint (adapts to input device)
  ctx.fillStyle='rgba(255,255,255,0.4)';ctx.font='11px monospace';ctx.textAlign='right';
  if (!isTouchDevice) ctx.fillText('ESC: EXIT',W-12,H-12);
}

// ‚îÄ‚îÄ MOBILE TOUCH ZONE OVERLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawTouchZones(){
  if (!isTouchDevice) return;
  // Fade out after 300 frames, never show after that
  if (touchHintTimer > 300) return;
  let alpha = touchHintTimer < 200 ? 0.22 : 0.22 * (1 - (touchHintTimer - 200) / 100);
  ctx.globalAlpha = alpha;
  // Move zone (left 60%)
  ctx.fillStyle = 'rgba(255,255,255,0.06)';
  ctx.fillRect(0, 32, W * 0.6, GROUND_Y - 32);
  ctx.globalAlpha = alpha * 1.2;
  ctx.fillStyle = '#FFF';
  ctx.font = 'bold 13px monospace';
  ctx.textAlign = 'center';
  ctx.fillText('DRAG TO MOVE', W * 0.3, GROUND_Y - 16);
  // Shoot zone (right 40%)
  ctx.fillStyle = 'rgba(255,111,71,0.08)';
  ctx.fillRect(W * 0.6, 32, W * 0.4, GROUND_Y - 32);
  ctx.fillStyle = ORANGE;
  ctx.fillText('TAP & HOLD TO SHOOT', W * 0.8, GROUND_Y - 16);
  // Divider line
  ctx.fillStyle = 'rgba(255,255,255,0.15)';
  ctx.fillRect(W * 0.6 - 1, 32, 2, GROUND_Y - 32);
  ctx.globalAlpha = 1;
}

// ‚îÄ‚îÄ TITLE SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawTitle(){
  let sL=level; level=1; drawSky(); drawGrassland(Date.now()/50); drawSun(); level=sL;
  ctx.fillStyle='rgba(0,20,45,0.82)'; ctx.fillRect(162,60,700,510);
  ctx.strokeStyle=GOLD; ctx.lineWidth=3; ctx.strokeRect(162,60,700,510);
  ctx.strokeStyle=ORANGE; ctx.lineWidth=1; ctx.strokeRect(167,65,690,500);
  ctx.textAlign='center';
  ctx.fillStyle=GOLD;   ctx.font='bold 52px monospace'; ctx.fillText('BODHI',W/2,130);
  ctx.fillStyle=ORANGE; ctx.font='bold 36px monospace'; ctx.fillText('SOLAR DEFENDER',W/2,175);
  ctx.fillStyle=GOLD;   ctx.fillRect(280,190,464,2);

  // Controls ‚Äî show both if not definitively touch-only
  ctx.fillStyle='#FFF'; ctx.font='15px monospace';
  if (!isTouchDevice) {
    ctx.fillText('Arrow Keys: Move  |  Spacebar: Shoot',W/2,230);
  } else {
    ctx.fillText('Left side: Drag to Move',W/2,222);
    ctx.fillText('Right side: Tap & Hold to Shoot',W/2,248);
  }
  ctx.fillStyle=GOLD;   ctx.font='14px monospace'; ctx.fillText('Collect energy bolts from the sun!',W/2,290);
  ctx.fillStyle=ORANGE; ctx.fillText('Destroy fossil fuel enemies!',W/2,315);
  ctx.fillStyle=GOLD;   ctx.fillText('Build solar panels & fill the power meter!',W/2,340);

  drawHero(W/2-48, 390);

  ctx.fillStyle='#FFF'; ctx.font='12px monospace';
  if (!isTouchDevice) ctx.fillText('ESC to exit at any time',W/2,460);
  ctx.fillStyle=GOLD; ctx.font='bold 20px monospace';
  let prompt = isTouchDevice ? 'TAP TO START' : 'PRESS SPACE TO START';
  if(Math.sin(Date.now()/400)>0) ctx.fillText(prompt, W/2, 510);
}

// ‚îÄ‚îÄ LEADERBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawLeaderboard(){
  let sL=level; level=1; drawSky(); drawGrassland(Date.now()/80); drawSun(); level=sL;
  updateFireworks();
  if(Math.random()<0.03) spawnFirework(100+Math.random()*800,60+Math.random()*200);
  drawFireworks();
  ctx.fillStyle='rgba(0,20,45,0.88)'; ctx.fillRect(162,30,700,580);
  ctx.strokeStyle=GOLD; ctx.lineWidth=3; ctx.strokeRect(162,30,700,580);
  ctx.strokeStyle=ORANGE; ctx.lineWidth=1; ctx.strokeRect(167,35,690,570);
  ctx.textAlign='center';
  ctx.fillStyle=GOLD; ctx.font='bold 32px monospace'; ctx.fillText('LEADERBOARD',W/2,78);
  ctx.fillStyle=ORANGE; ctx.fillRect(280,88,464,2);

  if(!nameEntered){
    ctx.fillStyle='#FFF'; ctx.font='18px monospace'; ctx.fillText('Enter your name:',W/2,125);
    ctx.fillStyle='rgba(0,40,80,0.8)'; ctx.fillRect(340,138,344,36);
    ctx.strokeStyle=GOLD; ctx.lineWidth=2; ctx.strokeRect(340,138,344,36);
    ctx.fillStyle=GOLD; ctx.font='bold 22px monospace'; ctx.textAlign='left';
    cursorBlink++; let dn=playerName; if(Math.floor(cursorBlink/30)%2===0) dn+='_';
    ctx.fillText(dn,352,163);
    ctx.textAlign='center';
    ctx.fillStyle=ORANGE; ctx.font='15px monospace';
    ctx.fillText(isTouchDevice ? 'Type name below, then tap CONFIRM' : 'Type your name, then press ENTER',W/2,195);
    ctx.fillStyle=GOLD; ctx.font='bold 20px monospace'; ctx.fillText('Your Score: '+score,W/2,225);
    // On touch devices, show a confirm button
    if(isTouchDevice){
      ctx.fillStyle=nameEntered?GOLD:'rgba(255,209,16,0.3)';
      ctx.fillRect(W/2-80,235,160,36);
      ctx.strokeStyle=GOLD; ctx.lineWidth=2; ctx.strokeRect(W/2-80,235,160,36);
      ctx.fillStyle=GOLD; ctx.font='bold 16px monospace'; ctx.fillText('CONFIRM',W/2,259);
    }
  } else {
    ctx.fillStyle=GOLD; ctx.font='bold 20px monospace'; ctx.fillText('Your Score: '+score,W/2,125);
  }

  let sY=nameEntered?155:270;
  ctx.fillStyle=ORANGE; ctx.font='bold 15px monospace';
  ctx.textAlign='left';  ctx.fillText('RANK',210,sY);
  ctx.textAlign='center';ctx.fillText('NAME',512,sY);
  ctx.textAlign='right'; ctx.fillText('SCORE',810,sY);
  ctx.fillStyle=GOLD; ctx.fillRect(200,sY+8,620,1);
  for(let i=0;i<leaderboard.length;i++){
    let e=leaderboard[i],ey=sY+28+i*28;
    ctx.fillStyle=e.isNew?GOLD:'#CCC'; ctx.font=e.isNew?'bold 15px monospace':'15px monospace';
    ctx.textAlign='left';  ctx.fillText('#'+(i+1),210,ey);
    ctx.textAlign='center';ctx.fillText(e.name,512,ey);
    ctx.textAlign='right'; ctx.fillText(e.score.toString(),810,ey);
    if(e.isNew) px(195,ey-12,630,18,'rgba(255,209,16,0.06)');
  }
  ctx.textAlign='center'; ctx.fillStyle='rgba(255,255,255,0.5)'; ctx.font='13px monospace';
  ctx.fillText(isTouchDevice ? 'TAP TO PLAY AGAIN' : 'PRESS SPACE TO PLAY AGAIN  |  ESC TO EXIT',W/2,595);
}

// ‚îÄ‚îÄ SPAWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spawnEnemy(){
  let types=['coal','oil','smoke'],cfg=levels[level-1];
  let spd=cfg.enemySpeed*(0.8+Math.random()*0.4)*(isTouchDevice ? 2.0 : 1.0);
  if(level===3){
    let side=Math.floor(Math.random()*4),ex,ey,vx,vy;
    if(side===0){ex=W+20;ey=30+Math.random()*(GROUND_Y-90);let a=(Math.random()-0.5)*1.4;vx=-Math.abs(Math.cos(a)*spd);vy=Math.sin(a)*spd;}
    else if(side===1){ex=-60;ey=30+Math.random()*(GROUND_Y-90);let a=(Math.random()-0.5)*1.0;vx=Math.abs(Math.cos(a)*spd);vy=Math.sin(a)*spd;}
    else if(side===2){ex=50+Math.random()*(W-100);ey=-60;let a=Math.PI/2+(Math.random()-0.5)*1.2;vx=Math.cos(a)*spd;vy=Math.abs(Math.sin(a)*spd);}
    else{ex=50+Math.random()*(W-100);ey=GROUND_Y+20;let a=-Math.PI/2+(Math.random()-0.5)*1.2;vx=Math.cos(a)*spd;vy=-Math.abs(Math.sin(a)*spd);}
    enemies.push({x:ex,y:ey,w:56,h:56,type:types[Math.floor(Math.random()*3)],speed:0,vx,vy,t:0,allDir:true});
  } else if(level===2){
    let angle=(Math.random()-0.5)*2.1,vy=Math.sin(angle)*spd,hspd=Math.abs(Math.cos(angle)*spd);
    enemies.push({x:W+20,y:30+Math.random()*(GROUND_Y-90),w:56,h:56,type:types[Math.floor(Math.random()*3)],speed:hspd,vx:0,vy,t:0,allDir:false});
  } else {
    enemies.push({x:W+20,y:30+Math.random()*(GROUND_Y-90),w:56,h:56,type:types[Math.floor(Math.random()*3)],speed:spd,vx:0,vy:0,t:0,allDir:false});
  }
}
function spawnBolt(){
  let sunX=900,sunY=80,angle=(Math.PI*0.55)+Math.random()*(Math.PI*0.6),spd=2+Math.random()*2;
  bolts.push({x:sunX-10+Math.random()*20,y:sunY+20+Math.random()*20,w:42,h:48,vx:Math.cos(angle)*spd,vy:Math.sin(angle)*spd,t:0});
}
function spawnSolarOrb(){
  let sunX=900,sunY=80,angle=(Math.PI*0.5)+Math.random()*(Math.PI*0.7),spd=1.5+Math.random()*1;
  solarOrbs.push({x:sunX-10+Math.random()*20,y:sunY+20,w:24,h:24,vx:Math.cos(angle)*spd,vy:Math.sin(angle)*spd,t:0});
}
function spawnBird(){
  bird={x:W+20,y:60+Math.random()*200,w:22,h:12,vx:-2.5,t:0,waveOff:Math.random()*Math.PI*2};
}

// ‚îÄ‚îÄ FLOWERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function bloomExistingPanels(){
  panelFlowers=[];
  let flowerColors=['#FF88AA','#FF6699','#FFAACC','#FF44AA','#FFB6C1','#FF69B4','#FF1493','#DA70D6','#FF007F','#FF77AA'];
  let worldBase=scrollX*0.5;
  for(let i=0;i<60;i++){
    panelFlowers.push({
      worldX: worldBase + Math.random()*(W+400)-200,
      stemH: 24+Math.random()*24,
      petalSize: 9+Math.random()*9,
      scale: 0.7+Math.random()*0.6,
      color: flowerColors[Math.floor(Math.random()*flowerColors.length)]
    });
  }
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function collides(a,b){return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;}
function resetLevel(){
  enemies=[];lasers=[];bolts=[];particles=[];solarPanels=[];celebrationParticles=[];
  powerMeter=0;enemyTimer=0;boltTimer=0;hero.x=100;hero.y=250;
  sunBrightness=1;invincibleTimer=0;screenDim=0;nextPanelX=60;
  solarOrbs=[];solarOrbTimer=0;tripleShot=false;tripleShotTimer=0;
  bird=null;birdTimer=0;birdUsed=false;flowersActive=false;flowerTimer=0;panelFlowers=[];
  touchHintTimer=0;
}
function addSolarPanel(){
  let pWX=nextPanelX+scrollX*0.5;
  nextPanelX+=110+Math.random()*50;
  if(nextPanelX>W) nextPanelX=60+Math.random()*100;
  solarPanels.push({worldX:pWX,y:GROUND_Y-12});
}
function addToLeaderboard(name,sc){
  leaderboard.push({name:name||'ANON',score:sc,isNew:true});
  leaderboard.sort((a,b)=>b.score-a.score);
  if(leaderboard.length>10) leaderboard.length=10;
}

// Touch leaderboard confirm button bounds (for tap detection)
const confirmBtn = { x: W/2-80, y: 235, w: 160, h: 36 };

// ‚îÄ‚îÄ UPDATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function update(){
  // ---- Title ----
  if(state==='title'){
    stopMusic();
    if(keys['Space']){
      state='playing';level=1;lives=3;score=0;resetLevel();startMusic(1);keys['Space']=false;
    }
    return;
  }

  // ---- Level complete ----
  if(state==='levelComplete'){
    updateCelebrationParticles();
    if(levelTransitionTimer%15===0&&levelTransitionTimer>20){
      for(let i=0;i<6;i++) celebrationParticles.push({x:100+Math.random()*800,y:H+5,vx:(Math.random()-0.5)*3,vy:-4-Math.random()*5,life:50+Math.random()*40,maxLife:90,color:[GOLD,ORANGE,'#FFF','#88DDFF'][Math.floor(Math.random()*4)],size:3+Math.random()*5,gravity:0.03});
    }
    levelTransitionTimer--;
    if(levelTransitionTimer<=0){
      if(level>=3){ state='victory';victoryTimer=0;victoryFireworks=[];playSfx('victory');stopMusic(); }
      else { level++;lives++;resetLevel();state='playing';startMusic(level); }
    }
    return;
  }

  // ---- Victory ----
  if(state==='victory'){
    victoryTimer++;updateFireworks();
    if(victoryTimer%25===0) spawnFirework(100+Math.random()*800,80+Math.random()*250);
    if(victoryTimer%40===0) spawnFirework(200+Math.random()*600,60+Math.random()*200);
    if(victoryTimer>=180){
      state='leaderboard';nameEntered=false;playerName='';
      nameInput.value='';nameInput.style.pointerEvents='auto';
      if(!isTouchDevice) nameInput.focus();
    }
    return;
  }

  // ---- Leaderboard ----
  if(state==='leaderboard'){
    if(!isTouchDevice){
      if(!nameEntered&&document.activeElement!==nameInput) nameInput.focus();
      if(!nameEntered&&keys['Enter']){
        nameEntered=true;
        leaderboard.forEach(e=>{e.isNew=false;});
        addToLeaderboard(playerName||'ANON',score);
        nameInput.style.pointerEvents='none';nameInput.blur();
        keys['Enter']=false;
      }
      if(nameEntered&&keys['Space']){ state='title';keys['Space']=false; }
    }
    return;
  }

  // ---- Game Over ----
  if(state==='gameOver'){
    stopMusic();
    if(keys['Space']){
      state='leaderboard';nameEntered=false;playerName='';nameInput.value='';victoryFireworks=[];
      nameInput.style.pointerEvents='auto';if(!isTouchDevice) nameInput.focus();keys['Space']=false;
    }
    return;
  }

  // ---- Playing ----
  gameTime++;
  if(state==='playing') touchHintTimer++;

  // Keyboard movement
  if(keys['ArrowUp'])   hero.y -= hero.speed;
  if(keys['ArrowDown']) hero.y += hero.speed;
  if(keys['ArrowLeft']) hero.x -= hero.speed;
  if(keys['ArrowRight'])hero.x += hero.speed;
  hero.x = Math.max(5, Math.min(W-hero.w-5, hero.x));
  hero.y = Math.max(5, Math.min(GROUND_Y-hero.h-20, hero.y));

  // Shooting ‚Äî keyboard or touch
  let wantsShoot = keys['Space'] || (touchShoot !== null);
  shootCooldown--;
  if(wantsShoot && shootCooldown<=0){
    if(tripleShot){
      lasers.push({x:hero.x+90,y:hero.y+18,w:20,h:5,vy:0});
      lasers.push({x:hero.x+80,y:hero.y+10,w:20,h:5,vy:-1.8});
      lasers.push({x:hero.x+80,y:hero.y+26,w:20,h:5,vy:1.8});
    } else {
      lasers.push({x:hero.x+90,y:hero.y+18,w:20,h:5,vy:0});
    }
    shootCooldown=12;playSfx('shoot');
  }

  scrollX += scrollSpeed;
  let cfg = levels[level-1];
  // Mobile is easier by default (fluid controls, auto-fire hold), so double the challenge
  const mobileHard = isTouchDevice ? 0.5 : 1.0; // lower = more frequent spawns

  // Enemies
  enemyTimer++; if(enemyTimer>=cfg.enemyInterval * mobileHard){ spawnEnemy();enemyTimer=0; }

  // Bolts (50% less frequent on levels 2 & 3)
  let boltInterval = cfg.enemyInterval * (level>=2 ? 2.4 : 1.2);
  boltTimer++; if(boltTimer>=boltInterval){ spawnBolt();boltTimer=0; }

  // Solar orb (rare)
  solarOrbTimer++; let orbInterval=cfg.enemyInterval*12; if(solarOrbTimer>=orbInterval){ spawnSolarOrb();solarOrbTimer=0; }

  // Triple shot countdown
  if(tripleShot){ tripleShotTimer--; if(tripleShotTimer<=0) tripleShot=false; }

  // Bird easter egg: level 2 only, once per game
  if(level===2&&!bird&&!birdUsed){ birdTimer++; if(birdTimer>600+Math.random()*400){ spawnBird();birdTimer=0; } }

  // Flower timer
  if(flowersActive){ flowerTimer++; if(flowerTimer>700){ flowersActive=false;panelFlowers=[];flowerTimer=0; } }

  // Laser movement
  for(let i=lasers.length-1;i>=0;i--){
    lasers[i].x+=8;
    if(lasers[i].vy) lasers[i].y+=lasers[i].vy;
    if(lasers[i].x>W+30) lasers.splice(i,1);
  }

  // Enemy movement & laser hit
  for(let i=enemies.length-1;i>=0;i--){
    let e=enemies[i]; e.t++;
    if(e.allDir){
      e.x+=e.vx;e.y+=e.vy;
      if(e.y<5){e.y=5;e.vy=Math.abs(e.vy);}
      if(e.y>GROUND_Y-60){e.y=GROUND_Y-60;e.vy=-Math.abs(e.vy);}
      if(e.x<-80||e.x>W+80||e.y<-80||e.y>H+80){enemies.splice(i,1);continue;}
    } else {
      e.x-=e.speed;e.y+=(e.vy||0);
      if(e.type==='smoke') e.y+=Math.sin(e.t/15)*0.7;
      if(e.y<5){e.y=5;if(e.vy)e.vy=Math.abs(e.vy);}
      if(e.y>GROUND_Y-60){e.y=GROUND_Y-60;if(e.vy)e.vy=-Math.abs(e.vy);}
      if(e.x<-70){enemies.splice(i,1);continue;}
    }
    for(let j=lasers.length-1;j>=0;j--){
      if(collides(lasers[j],e)){ spawnExplosion(e.x+28,e.y+28);score+=50;playSfx('explode');enemies.splice(i,1);lasers.splice(j,1);break; }
    }
  }

  // Energy bolt pickup
  for(let i=bolts.length-1;i>=0;i--){
    let b=bolts[i]; b.x+=b.vx;b.y+=b.vy;b.t++;
    if(b.y>H||b.x<-50||b.y<-50){bolts.splice(i,1);continue;}
    let hB={x:hero.x+10,y:hero.y+6,w:76,h:36};
    if(collides(hB,b)){
      powerMeter=Math.min(10,powerMeter+1);score+=100;addSolarPanel();
      screenDim=Math.max(0,screenDim-0.15);playSfx('collect');
      for(let k=0;k<8;k++) particles.push({x:b.x+21,y:b.y+24,vx:(Math.random()-0.5)*4,vy:(Math.random()-0.5)*4,life:18,maxLife:18,color:GOLD,size:4});
      bolts.splice(i,1);
      if(powerMeter>=10){ state='levelComplete';levelTransitionTimer=180;score+=500;playSfx('levelup');spawnCelebration();stopMusic(); }
    }
  }

  // Solar orb pickup
  for(let i=solarOrbs.length-1;i>=0;i--){
    let o=solarOrbs[i]; o.x+=o.vx;o.y+=o.vy;o.t++;
    if(o.y>H||o.x<-60||o.y<-60){solarOrbs.splice(i,1);continue;}
    let hB={x:hero.x+10,y:hero.y+6,w:76,h:36};
    if(collides(hB,o)){
      tripleShot=true;tripleShotTimer=300;score+=200;playSfx('levelup');
      for(let k=0;k<16;k++) particles.push({x:o.x+12,y:o.y+12,vx:(Math.random()-0.5)*6,vy:(Math.random()-0.5)*6,life:25,maxLife:25,color:['#FF8C00','#FFC200','#FFE866','#FFF'][Math.floor(Math.random()*4)],size:4+Math.random()*4});
      solarOrbs.splice(i,1);
    }
  }

  // Bird pickup
  if(bird){
    bird.t++;bird.x+=bird.vx;bird.y+=Math.sin(bird.t*0.05+bird.waveOff)*0.8;
    if(bird.x<-30){ bird=null;birdUsed=true; }
    else {
      let hB={x:hero.x+10,y:hero.y+6,w:76,h:36};
      if(collides(hB,bird)){
        score+=300;flowersActive=true;flowerTimer=0;bloomExistingPanels();
        for(let k=0;k<20;k++) particles.push({x:bird.x+11,y:bird.y+6,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,life:30,maxLife:30,color:['#FF88AA','#FFDD55','#FFB6C1','#FF69B4'][Math.floor(Math.random()*4)],size:3+Math.random()*4});
        bird=null;birdUsed=true;
      }
    }
  }

  // Enemy collision with hero
  if(invincibleTimer>0){ invincibleTimer--; }
  else {
    let hB={x:hero.x+10,y:hero.y+6,w:76,h:36};
    for(let i=enemies.length-1;i>=0;i--){
      if(collides(hB,enemies[i])){
        lives--;powerMeter=Math.max(0,powerMeter-2);sunBrightness=0.3;sunDimTimer=90;
        invincibleTimer=90;screenDim=Math.min(0.75,screenDim+0.35);playSfx('hit');
        spawnExplosion(hero.x+48,hero.y+24);enemies.splice(i,1);flashTimer=10;
        if(lives<=0){ state='gameOver';stopMusic(); }
        break;
      }
    }
  }

  if(sunDimTimer>0){ sunDimTimer--;sunBrightness=sunDimTimer<=0?1:0.3+0.7*(1-sunDimTimer/90); }
  for(let i=particles.length-1;i>=0;i--){ let p=particles[i];p.x+=p.vx;p.y+=p.vy;p.life--;if(p.life<=0)particles.splice(i,1); }
  if(flashTimer>0) flashTimer--;
}

// ‚îÄ‚îÄ DRAW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function draw(){
  ctx.clearRect(0,0,W,H);

  if(state==='title')      { drawTitle();      return; }
  if(state==='leaderboard'){ drawLeaderboard(); return; }

  drawBackground(scrollX);
  drawSolarPanels();
  drawFlowers();
  bolts.forEach(b=>drawBolt(b));
  solarOrbs.forEach(o=>drawSolarOrb(o));
  if(bird) drawBird(bird);
  enemies.forEach(e=>drawEnemy(e));
  lasers.forEach(l=>drawLaser(l));
  if(state==='playing'||state==='levelComplete') drawHero(hero.x,hero.y);
  particles.forEach(p=>{ctx.globalAlpha=p.life/p.maxLife;ctx.fillStyle=p.color;ctx.fillRect(Math.floor(p.x),Math.floor(p.y),p.size,p.size);});
  ctx.globalAlpha=1;
  drawHUD();

  // Mobile touch zones (fades out early game)
  if(state==='playing') drawTouchZones();

  // Triple shot indicator
  if(tripleShot){
    let pct=tripleShotTimer/300;
    ctx.fillStyle='#FF8C00';ctx.font='bold 13px monospace';ctx.textAlign='left';
    ctx.fillText('‚ö° TRIPLE CANNON: '+(Math.ceil(tripleShotTimer/60))+'s',60,55);
    ctx.fillStyle='rgba(255,200,0,0.5)';ctx.fillRect(60,58,(W-80)*pct,4);
  }

  if(flashTimer>0){ ctx.globalAlpha=0.3;ctx.fillStyle=ORANGE;ctx.fillRect(0,0,W,H);ctx.globalAlpha=1; }
  if(screenDim>0){  ctx.globalAlpha=screenDim;ctx.fillStyle='#000';ctx.fillRect(0,0,W,H);ctx.globalAlpha=1; }

  // Level complete overlay
  if(state==='levelComplete'){
    drawCelebrationParticles();
    ctx.fillStyle='rgba(0,20,45,0.75)';ctx.fillRect(200,170,624,280);
    ctx.strokeStyle=GOLD;ctx.lineWidth=3;ctx.strokeRect(200,170,624,280);
    ctx.strokeStyle=ORANGE;ctx.lineWidth=1;ctx.strokeRect(205,175,614,270);
    ctx.textAlign='center';
    ctx.fillStyle=GOLD;ctx.font='32px monospace';ctx.fillText('‚òÖ ‚òÖ ‚òÖ',W/2,208);
    ctx.fillStyle=GOLD;ctx.font='bold 36px monospace';ctx.fillText('LEVEL '+level+' COMPLETE!',W/2,252);
    ctx.fillStyle='#FFF';ctx.font='bold 22px monospace';ctx.fillText('You saved '+levelNames[level-1]+'!',W/2,290);
    ctx.fillStyle=ORANGE;ctx.font='18px monospace';ctx.fillText('Score: '+score,W/2,325);
    ctx.fillStyle=GOLD;ctx.font='16px monospace';ctx.fillText(solarPanels.length+' solar panels installed!',W/2,355);
    if(level<3){
      ctx.fillStyle=GOLD;ctx.font='bold 16px monospace';ctx.fillText('+1 EXTRA LIFE!',W/2,385);
      ctx.fillStyle=ORANGE_LIGHT;ctx.font='16px monospace';
      if(Math.sin(Date.now()/300)>0) ctx.fillText('Next: '+levels[level].name+' awaits...',W/2,415);
    } else {
      ctx.fillStyle=GOLD;ctx.font='bold 16px monospace';
      if(Math.sin(Date.now()/300)>0) ctx.fillText('Preparing final celebration...',W/2,400);
    }
  }

  // Game over overlay
  if(state==='gameOver'){
    ctx.fillStyle='rgba(0,10,20,0.85)';ctx.fillRect(0,0,W,H);
    ctx.textAlign='center';
    ctx.fillStyle=ORANGE;ctx.font='bold 52px monospace';ctx.fillText('GAME OVER',W/2,250);
    ctx.fillStyle='#FFF';ctx.font='26px monospace';ctx.fillText('Final Score: '+score,W/2,310);
    ctx.fillStyle='rgba(255,255,255,0.6)';ctx.font='16px monospace';
    ctx.fillText('The fossil fuels won this time...',W/2,355);
    ctx.fillText('But the sun will rise again!',W/2,380);
    ctx.fillStyle=GOLD;ctx.font='18px monospace';
    let gop = isTouchDevice ? 'TAP TO CONTINUE' : 'PRESS SPACE TO CONTINUE';
    if(Math.sin(Date.now()/400)>0) ctx.fillText(gop,W/2,430);
  }

  // Victory overlay
  if(state==='victory'){
    let t=victoryTimer;
    let grad=ctx.createLinearGradient(0,0,0,H);
    grad.addColorStop(0,NAVY);grad.addColorStop(0.4+Math.sin(t/40)*0.1,'#0A2E5C');grad.addColorStop(1,'#1A5090');
    ctx.fillStyle=grad;ctx.fillRect(0,0,W,H);
    drawFireworks();
    let sp=70+Math.sin(t/15)*10;
    ctx.beginPath();ctx.arc(W/2,160,sp,0,Math.PI*2);ctx.fillStyle=GOLD;ctx.fill();
    ctx.beginPath();ctx.arc(W/2,160,sp-18,0,Math.PI*2);ctx.fillStyle='#FFE866';ctx.fill();
    ctx.beginPath();ctx.arc(W/2,160,sp-36,0,Math.PI*2);ctx.fillStyle='#FFFBE0';ctx.fill();
    ctx.globalAlpha=0.3;ctx.fillStyle=GOLD;
    for(let i=0;i<12;i++){let a=(t/50)+i*Math.PI/6;ctx.save();ctx.translate(W/2,160);ctx.rotate(a);ctx.fillRect(-3,-sp-30,6,30);ctx.restore();}
    ctx.globalAlpha=1;
    ctx.fillStyle='rgba(0,20,45,0.8)';ctx.fillRect(162,240,700,340);
    ctx.strokeStyle=GOLD;ctx.lineWidth=3;ctx.strokeRect(162,240,700,340);
    ctx.strokeStyle=ORANGE;ctx.lineWidth=1;ctx.strokeRect(167,245,690,330);
    ctx.textAlign='center';
    ctx.fillStyle=GOLD;ctx.font='28px monospace';
    let sC=Math.min(5,Math.floor(t/20)),sS='';for(let i=0;i<sC;i++)sS+='‚òÖ ';ctx.fillText(sS.trim(),W/2,275);
    ctx.fillStyle=GOLD;ctx.font='bold 42px monospace';ctx.fillText('VICTORY!',W/2,320);
    ctx.fillStyle=ORANGE;ctx.font='bold 24px monospace';ctx.fillText('THE PLANET IS SAVED!',W/2,360);
    ctx.fillStyle='#FFF';ctx.font='20px monospace';ctx.fillText('Final Score: '+score,W/2,400);
    let pC=Math.min(8,Math.floor(t/12));for(let i=0;i<pC;i++) drawSolarPanel(180+i*82,430);
    ctx.fillStyle=GOLD;ctx.font='bold 17px monospace';ctx.fillText('Clean energy now powers the world!',W/2,520);
    let hVX=(t*2)%(W+200)-100,hVY=200+Math.sin(t/20)*35;drawHero(hVX,hVY);
  }
}

// ‚îÄ‚îÄ GAME LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function gameLoop(){ update(); draw(); requestAnimationFrame(gameLoop); }
gameLoop();
</script>
</body>
</html>
